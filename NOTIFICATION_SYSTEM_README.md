# 通知系统说明

## 概述

本应用的通知系统分为两个层次：

1. **全局好友通知设置**（在好友列表中管理）
2. **个人好友通知设置**（在聊天界面中管理）

## 通知服务架构

### 1. AllFriendsNotificationService（全局好友通知服务）
- **位置**: `lib/services/all_friends_notification_service.dart`
- **功能**: 管理所有好友的全局通知设置
- **设置项**:
  - 好友消息通知开关
  - 震动提醒开关
  - 铃声提醒开关
- **访问位置**: 好友列表界面的通知设置按钮

### 2. FriendNotificationService（个人好友通知服务）
- **位置**: `lib/services/friend_notification_service.dart`
- **功能**: 管理特定好友的个人通知设置
- **设置项**:
  - 该好友的消息通知开关
  - 该好友的震动提醒开关
  - 该好友的铃声提醒开关
- **访问位置**: 聊天界面的菜单选项



## 通知触发逻辑

当收到新消息时，通知系统会按以下逻辑判断是否触发通知：

```
收到新消息
    ↓
检查全局好友通知设置 (AllFriendsNotificationService)
    ↓ (如果全局关闭，则不通知)
检查个人好友通知设置 (FriendNotificationService)
    ↓ (如果个人关闭，则不通知)
检查震动设置 (全局设置 AND 个人设置)
    ↓
检查铃声设置 (全局设置 AND 个人设置)
    ↓
触发通知
```

## 使用场景

### 场景1：用户想要关闭所有好友的通知
1. 进入好友列表
2. 点击通知设置按钮
3. 关闭"好友消息通知"开关
4. 结果：所有好友的消息都不会触发通知

### 场景2：用户想要关闭特定好友的通知
1. 进入该好友的聊天界面
2. 点击菜单按钮
3. 在"好友的通知设置"中关闭"新消息通知"
4. 结果：只有该好友的消息不会触发通知，其他好友正常

### 场景3：用户想要关闭震动但保留铃声
1. 在好友列表中关闭"震动提醒"
2. 在特定好友的聊天界面中关闭"震动提醒"
3. 结果：该好友的消息只会播放铃声，不会震动

## 设置优先级

- **全局设置** > **个人设置**
- 如果全局设置关闭，个人设置无效
- 如果全局设置开启，个人设置生效
- 震动和铃声需要同时满足全局和个人设置才会触发

## 数据存储

- 全局设置存储在 `SharedPreferences` 中，键名以 `all_friends_` 开头
- 个人设置存储在 `SharedPreferences` 中，键名以 `friend_notification_` 开头
- 设置会在应用重启后保持

## 测试功能

- 可以通过实际发送消息来测试通知设置是否生效
- 建议测试场景：
  1. 关闭全局好友通知，发送消息验证无通知
  2. 开启全局通知，关闭特定好友通知，验证该好友无通知
  3. 调整震动和铃声设置，验证组合效果 